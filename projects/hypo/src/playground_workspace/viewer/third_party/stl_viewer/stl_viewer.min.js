//=========== Stl Viewer v1.10, by Omri Rips, Viewstl.com, May 2020 ; admin@viewstl.com ===========
var stl_viewer_script_path="";function StlViewer(e,t){e||console.log("error: no parent element");var o=this;this.error=null,this.options=t,this.parent_element=e,this.get_opt=function(e,t){return o.options?!1!==o.options[e]&&(o.options[e]?o.options[e]:t):t},this.canvas_width="100%",this.canvas_height="100%",this.bg_color="transparent",this.models_to_add=null,this.models=new Array,this.models_count=0,this.models_ref=new Array,this.allow_drag_and_drop=o.get_opt("allow_drag_and_drop",!0),this.model_loaded_callback=null,this.all_loaded_callback=null,this.load_error_callback=null,this.loading_progress_callback=null,this.max_model_id=0,this.load_status=new Array,this.load_session=0,this.loaded_models_arr=new Array,this.status=0,this.onmousedown_callback=null,this.zoom=-1,this.camerax=0,this.cameray=0,this.cameraz=0,this.camera_state=null,this.auto_rotate=!1,this.mouse_zoom=!0,this.load_three_files=o.get_opt("load_three_files",stl_viewer_script_path),this.ready="undefined"!=typeof THREE,this.ready_callback=null,this.auto_resize=!0,this.on_model_drop=null,this.center_models=!0,this.controls_type=0,this.zoom=-1,this.pre_loaded_ab_files=null,this.pre_loaded_vsj=null,this.zip_load_count=-1,this.set_on_model_mousedown=function(e){o.onmousedown_callback=e,o.onmousedown_callback&&(o.parent_element.addEventListener("mousedown",o.onmousedown),o.parent_element.addEventListener("touchstart",o.onmousedown))},this.set_drag_and_drop=function(e){e?(o.parent_element.addEventListener("dragover",o.handleDragOver),o.parent_element.addEventListener("drop",o.handleFileDrop)):(o.parent_element.removeEventListener("dragover",o.handleDragOver),o.parent_element.removeEventListener("drop",o.handleFileDrop))},this.set_options=function(){o.canvas_width=o.get_opt("width",o.canvas_width),o.canvas_height=o.get_opt("height",o.canvas_height),o.bg_color=o.get_opt("bgcolor",o.bg_color),o.models_to_add=o.get_opt("models",o.models_to_add),o.model_loaded_callback=o.get_opt("model_loaded_callback",o.model_loaded_callback),o.all_loaded_callback=o.get_opt("all_loaded_callback",o.all_loaded_callback),o.load_error_callback=o.get_opt("load_error_callback",o.load_error_callback),o.loading_progress_callback=o.get_opt("loading_progress_callback",o.loading_progress_callback),o.onmousedown_callback=o.get_opt("on_model_mousedown",o.onmousedown_callback),o.onmousedown_callback||(o.onmousedown_callback=o.get_opt("on_model_mouseclick",null)),o.zoom=o.get_opt("zoom",o.zoom),o.camerax=o.get_opt("camerax",o.camerax),o.cameray=o.get_opt("cameray",o.cameray),o.auto_rotate=o.get_opt("auto_rotate",o.auto_rotate),o.mouse_zoom=o.get_opt("mouse_zoom",o.mouse_zoom),o.ready_callback=o.get_opt("ready_callback",null),o.auto_resize=o.get_opt("auto_resize",o.auto_resize),o.on_model_drop=o.get_opt("on_model_drop",o.on_model_drop),o.center_models=o.get_opt("center_models",o.center_models),o.controls_type=o.get_opt("controls",o.controls_type),o.zoom>=0?o.cameraz=o.zoom:o.cameraz=o.get_opt("cameraz",o.cameraz),o.camera_state=o.get_opt("camera_state",o.camera_state),o.allow_drag_and_drop&&o.set_drag_and_drop(!0)},o.is_ie=!!window.MSStream,this.MSG2WORKER_DATA=0,this.MSG2WORKER_LOAD=1,this.MSG2WORKER_ERROR=2,this.MSGFROMWORKER_STL_LOADED=3,this.MSGFROMWORKER_LOAD_IN_PROGRESS=4,this.load_model=function(e){return o.max_model_id=Math.max(o.max_model_id,e.id),e.filename||e.local_file?o.load_from_stl_file(e,!1):e.mesh?o.add_from_existing_mesh(e):void o.models_count--},this.add_from_existing_mesh=function(e){o.set_model_custom_props(e),e.mesh.model_id=e.id,o.set_geo_minmax(e),o.recalc_dims(e),o.scene.add(e.mesh),o.model_loaded(e.id),o.check_loading_status(e,0,0),e.mesh.geometry.boundingBox||e.mesh.geometry.computeBoundingBox(),o.model_loaded_callback&&o.model_loaded_callback(e.id)},this.load_from_stl_file=function(e){var t=new Worker(("string"==typeof o.load_three_files?o.load_three_files:"")+"load_stl.min.js");t.onmessage=function(a){switch(a.data.msg_type){case o.MSGFROMWORKER_STL_LOADED:e.colors=a.data.colors;var i=o.vf_to_geo(a.data.vertices,a.data.faces,!!a.data.colors&&a.data.colors);if(i){var s=new THREE.MeshLambertMaterial({color:9474192,overdraw:1,wireframe:!1,vertexColors:e.color?THREE.NoColors:THREE.FaceColors});o.is_ie||(s.side=THREE.DoubleSide),e.display||(e.display="flat"),o.set_material_display(e.display,s,i),e.mesh=new THREE.Mesh(i,s),o.set_model_custom_props(e),o.set_geo_minmax(e),e.mesh.model_id=e.id,o.recalc_dims(e),o.scene.add(e.mesh),o.model_loaded(e.id),o.model_loaded_callback&&o.model_loaded_callback(e.id)}else console.log("Error VF data ");t.terminate(),t=void 0,o.pre_loaded_ab_files&&e.filename&&o.pre_loaded_ab_files[e.filename]&&delete o.pre_loaded_ab_files[e.filename];break;case o.MSGFROMWORKER_LOAD_IN_PROGRESS:o.check_loading_status(e,a.data.loaded,a.data.total);break;case o.MSG2WORKER_ERROR:o.models_count--,o.model_error("ERROR: "+a.data.data,o.load_error_callback),o.pre_loaded_ab_files&&e.filename&&o.pre_loaded_ab_files[e.filename]&&delete o.pre_loaded_ab_files[e.filename]}},e.bytes_loaded=0,e.bytes_total=0;var a=null;o.pre_loaded_ab_files&&e.filename&&o.pre_loaded_ab_files[e.filename]&&(a=o.pre_loaded_ab_files[e.filename]),t.postMessage({msg_type:o.MSG2WORKER_DATA,data:e,load_from_blob_or_ab:a,get_progress:null!=o.loading_progress_callback}),t.postMessage({msg_type:o.MSG2WORKER_LOAD})},this.model_loaded=function(e){o.loaded_models_arr[e]=1,Object.keys(o.loaded_models_arr).length>=o.models_count&&(o.camera_state?o.camera_state=null:o.set_zoom(),o.set_light(),o.load_session++,o.all_loaded_callback&&o.all_loaded_callback())},this.remove_model=function(e){if(void 0===o.models_ref[e])return o.model_error("remove_model - id not found: "+e);var t=o.models[o.models_ref[e]];t&&(delete o.models[o.models_ref[e]],delete o.models_ref[e],delete o.loaded_models_arr[e],o.models_count=Object.keys(o.models).length,o.scene.remove(t.mesh))},this.zoom_done=!1,this.set_zoom=function(e,t){if(e&&(o.zoom=e),!(o.zoom_done&&!t&&o.zoom>=0)){o.zoom_done=!0;var a=Math.max(2*o.maxx,2*o.maxy,o.maxz);o.camera.position.set(o.camera.position.x,o.camera.position.y,o.zoom>=0?o.zoom:1.2*a*Math.max(1,o.camera.aspect/2))}},this.get_camera_state=function(){if(!o.camera)return null;var e=new THREE.Vector3,t=new THREE.Vector3,a=new THREE.Vector3(0,0,0);return e.copy(o.camera.position),t.copy(o.camera.up),o.controls&&a.copy(o.controls.target),{position:e,up:t,target:a}},this.set_camera_state=function(e){if(!o.camera)return null;if(!e)return o.model_error("set_camera_state - no state vector");if(void 0!==e.position){if(void 0===e.position.x)return o.model_error("set_camera_state - invalid position x");if(void 0===e.position.y)return o.model_error("set_camera_state - invalid position y");if(void 0===e.position.z)return o.model_error("set_camera_state - invalid position z");o.camera.position.set(e.position.x,e.position.y,e.position.z)}if(void 0!==e.up){if(void 0===e.up.x)return o.model_error("set_camera_state invalid up x");if(void 0===e.up.y)return o.model_error("set_camera_state invalid up y");if(void 0===e.up.z)return o.model_error("set_camera_state invalid up z");o.camera.up.set(e.up.x,e.up.y,e.up.z)}if(o.controls&&void 0!==e.target){if(void 0===e.target.x)return o.model_error("set_camera_state - invalid target x");if(void 0===e.target.y)return o.model_error("set_camera_state - invalid target y");if(void 0===e.target.z)return o.model_error("set_camera_state - invalid target z");o.controls.target.set(e.target.x,e.target.y,e.target.z)}},this.set_center_models=function(e){o.center_models=e},this.set_light=function(){o.directionalLight.position.x=2*o.maxy,o.directionalLight.position.y=2*o.miny,o.directionalLight.position.z=2*o.maxz,o.pointLight.position.x=(o.miny+o.maxy)/2,o.pointLight.position.y=(o.miny+o.maxy)/2,o.pointLight.position.z=2*o.maxz},this.stop_auto_zoom=function(){o.zoom=o.camera.position.z},this.set_camera=function(e,t,a){t&&(o.zoom=t),o.camera.position.set(o.is_empty(e)?o.camera.position.x:e,o.is_empty(t)?o.camera.position.y:t,o.zoom>=0?o.zoom:Math.max(3*o.maxx,3*o.maxy,3.5*o.maxz))},this.set_auto_zoom=function(){o.set_zoom(-1)},this.check_loading_status=function(e,t,a){e&&(o.load_status[e.id]={loaded:t,total:a,load_session:o.load_session}),o.loading_progress_callback&&Object.keys(o.load_status).length==o.models_count&&o.loading_progress_callback(o.load_status,o.load_session)},this.set_edges=function(e,t){if(void 0===o.models_ref[e])return o.model_error("set_edges - id not found: "+e);var a=o.models[o.models_ref[e]];a&&o.set_or_update_geo_edges(a,t)},this.set_or_update_geo_edges=function(e,t,a){if(t&&!a||(e.edges&&o.scene.remove(e.edges),e.edges=null,t)){var i=!1;if(a=a||!1,!e.edges||a){var s=e.mesh.geometry;e.edges=new THREE.LineSegments(new THREE.EdgesGeometry(s),o.edges_material),i=!0}(e.x||e.y||e.z)&&e.edges.position.set(e.x?e.x:0,e.y?e.y:0,e.z?e.z:0),e.edges.rotation.setFromRotationMatrix(e.mesh.matrix),i&&o.scene.add(e.edges)}},this.set_model_custom_props=function(e){e.x=e.x?e.x:0,e.y=e.y?e.y:0,e.z=e.z?e.z:0,e.mesh.position.set(e.x,e.y,e.z),e.color?o.update_mesh_color(e.mesh,e.color,!1):e.colors&&o.update_mesh_color(e.mesh,"#FFFFFF",!0),e.rotationx=e.rotationx?e.rotationx:0,e.rotationy=e.rotationy?e.rotationy:0,e.rotationz=e.rotationz?e.rotationz:0,(e.rotationx||e.rotationy||e.rotationz)&&this.rotate(e.id,e.rotationx,e.rotationy,e.rotationz);var t=void 0!==e.scale?e.scale:1,a=void 0!==e.scalex?e.scalex:t,i=void 0!==e.scaley?e.scaley:t,s=void 0!==e.scalez?e.scalez:t;e.scalex=a,e.scaley=i,e.scalez=s,1==a&&1==i&&1==s||o.scale_geo(e.mesh.geometry,a,i,s),e.view_edges&&o.set_or_update_geo_edges(e,!0),e.opacity&&this.set_material_opacity(e.mesh.material,e.opacity),e.animation&&(o.animation[e.id]=1)},this.set_scale=function(e,t,a,i){if(void 0===o.models_ref[e])return o.model_error("set_scale - id not found: "+e);var s=o.models[o.models_ref[e]];if(s&&s.mesh&&s.mesh.geometry){var n=Math.max(s.scalex,.01),r=Math.max(s.scaley,.01),l=Math.max(s.scalez,.01);t&&(s.scalex=Math.max(t,.01)),s.scaley=Math.max(a||t,.01),s.scalez=Math.max(i||t,.01),o.scale_geo(s.mesh.geometry,s.scalex/n,s.scaley/r,s.scalez/l),s.edges&&o.set_or_update_geo_edges(s,!0,!0)}},this.scale_geo=function(e,t,o,a){e.scale(t,o,a)},this.recalc_dims=function(e){var t=e.mesh.geometry;o.maxx=o.maxx?Math.max(o.maxx,t.maxx+e.x):t.maxx+e.x,o.maxy=o.maxy?Math.max(o.maxy,t.maxy+e.y):t.maxy+e.y,o.maxz=o.maxz?Math.max(o.maxz,t.maxz+e.z):t.maxz+e.z,o.minx=o.maxx?Math.min(o.minx,t.minx+e.x):t.minx+e.x,o.miny=o.maxy?Math.min(o.miny,t.miny+e.y):t.miny+e.y,o.minz=o.maxz?Math.min(o.minz,t.minz+e.z):t.minz+e.z},this.update_mesh_color=function(e,t,o){null!=e&&("transparent"!=t?(e.traverse(function(e){e.visible=!0}),e.material.vertexColors=o?THREE.FaceColors:THREE.NoColors,o&&!t&&(t="#FFFFFF"),t&&e.material.color.set(parseInt(t.substr(1),16)),e.material.needsUpdate=!0):e.traverse(function(e){e.visible=!1}))},this.set_color=function(e,t){if(void 0===o.models_ref[e])return o.model_error("set_color - id not found: "+e);var a=o.models[o.models_ref[e]];a&&a.mesh&&(a.color=t,o.update_mesh_color(a.mesh,t,!t&&a.colors))},this.error_in_model=function(e){if(!e.id&&0!=e.id&&-1!=e.id)return o.model_error("missing id");if(!Number.isInteger(e.id))return o.model_error("invalid id");if(e.id<-1)return o.model_error("id must be positive");if(!e.filename&&!e.mesh&&!e.local_file){if(!e.name)return o.model_error("missing filename or mesh");e.filename=e.name}return o.models_ref[e.id]?o.model_error("such model ID already exists: "+e.id):null},this.model_error=function(e,t){return console.log(e),o.status=-1,o.error=e,t&&t(e),e},this.set_bg_color=function(e){"transparent"==e?this.renderer.setClearColor(0,0):this.renderer.setClearColor(e,1)},this.set_display=function(e,t){if(void 0===o.models_ref[e])return o.model_error("set_display - id not found: "+e);var a=o.models[o.models_ref[e]];a&&(o.set_material_display(t,a.mesh.material,a.mesh.geometry),a.display=t,a.mesh&&(a.mesh.normalsNeedUpdate=!0))},this.set_opacity=function(e,t){if(void 0===o.models_ref[e])return o.model_error("set_display - id not found: "+e);var a=o.models[o.models_ref[e]];a&&this.set_material_opacity(a.mesh.material,t)},this.set_material_opacity=function(e,t){e&&(t<1?(e.opacity=t,e.transparent=!0):(e.opacity=1,e.transparent=!1))},this.onmousedown=function(e){switch(e.preventDefault(),e.type){case"touchstart":var t=e.touches[0]||e.changedTouches[0];o.mouse.x=(t.pageX-o.parent_element.offsetLeft)/o.parent_element.clientWidth*2-1,o.mouse.y=-(t.pageY-o.parent_element.offsetTop)/o.parent_element.clientHeight*2+1;break;default:o.mouse.x=(e.clientX-o.parent_element.offsetLeft)/o.parent_element.clientWidth*2-1,o.mouse.y=-(e.clientY-o.parent_element.offsetTop)/o.parent_element.clientHeight*2+1}o.raycaster.setFromCamera(o.mouse,o.camera);var a=o.raycaster.intersectObjects(o.scene.children);if(a.length>0){if(void 0===a[0].object.model_id)return;o.onmousedown_callback&&o.onmousedown_callback(a[0].object.model_id,e,a[0].distance)}},this.is_empty=function(e){return!e&&0!==e},this.set_position=function(e,t,a,i){if(void 0===o.models_ref[e])return o.model_error("set_position - id not found: "+e);var s=o.models[o.models_ref[e]];s&&s.mesh&&(s.x=o.is_empty(t)?s.x:t,s.y=o.is_empty(a)?s.y:a,s.z=o.is_empty(i)?s.z:i,s.mesh.position.set(s.x,s.y,s.z),s.edges&&o.set_or_update_geo_edges(s,!0,!0))},this.set_material_display=function(e,t,o){switch(e.toLowerCase()){case"wireframe":t.wireframe=!0;break;case"smooth":t.wireframe=!1,t.shading=THREE.SmoothShading,o&&(o.mergeVertices(),o.computeVertexNormals());break;case"flat":t.wireframe=!1,t.shading=THREE.FlatShading,o&&o.computeFlatVertexNormals()}},this.rotate=function(e,t,a,i){if(void 0===o.models_ref[e])return o.model_error("rotate - id not found: "+e);var s=o.models[o.models_ref[e]];s&&(t&&o.rotateAroundWorldAxis(s.mesh,o.WORLD_X_VECTOR,t),a&&o.rotateAroundWorldAxis(s.mesh,o.WORLD_Y_VECTOR,a),i&&o.rotateAroundWorldAxis(s.mesh,o.WORLD_Z_VECTOR,i),s.edges&&o.set_or_update_geo_edges(s,!0))},this.rotateAroundWorldAxis=function(e,t,o){var a=new THREE.Matrix4;a.makeRotationAxis(t,o),a.multiply(e.matrix),e.matrix=a,e.rotation.setFromRotationMatrix(e.matrix)},this.get_model_filename=function(e){return e.temp_filename?e.temp_filename:e.orig_url?e.orig_url:e.local_file&&e.local_file.name?e.local_file.name:e.orig_filename?e.orig_filename:e.filename?e.filename instanceof File?File.name:e.filename:null},this.add_model=function(e,t){if(Array.isArray(e))return o.add_models(e);if(!o.ready)return o.models_to_add.push(e),o.model_error("THREE JS files are not ready");var a=o.get_model_filename(e);if(a)switch(a.split(".").pop()){case"vsj":return o.load_vsj(e.local_file?e.local_file:a);case"vsb":return o.load_vsb(e.local_file?e.local_file:a)}void 0===e.id&&(e.id=-1);var i=o.error_in_model(e);if(i)return i;-1==e.id&&(e.id=++o.max_model_id),o.models.push(e);var s=o.models.indexOf(e);return t||void 0===o.models_ref[e.id]&&o.models_count++,o.models_ref[e.id]=s,o.load_model(e),o.status},this.add_models=function(e){if(!Array.isArray(e))return o.add_model(e);o.status=0;var t=Object.keys(e);return t.forEach(function(a){var i=o.get_model_filename(e[t[a]]);if(i)switch(i.split(".").pop()){case"vsj":case"vsb":break;default:void 0===o.models_ref[e[a].id]&&o.models_count++}else void 0===o.models_ref[e[a].id]&&o.models_count++}),t.forEach(function(t){o.add_model(e[t],!0)}),o.status},this.calc_volume_and_area=function(e){var t,o,a,i,s,n,r,l,d,_,c,m,u,f,h=e.faces.length,p=0,g=0;for(_=0;_<h;_++)t=e.vertices[e.faces[_].a].x,i=e.vertices[e.faces[_].a].y,r=e.vertices[e.faces[_].a].z,o=e.vertices[e.faces[_].b].x,s=e.vertices[e.faces[_].b].y,l=e.vertices[e.faces[_].b].z,p+=-(a=e.vertices[e.faces[_].c].x)*s*r+o*(n=e.vertices[e.faces[_].c].y)*r+a*i*l-t*n*l-o*i*(d=e.vertices[e.faces[_].c].z)+t*s*d,f=((c=e.vertices[e.faces[_].a].distanceTo(e.vertices[e.faces[_].b]))+(m=e.vertices[e.faces[_].b].distanceTo(e.vertices[e.faces[_].c]))+(u=e.vertices[e.faces[_].c].distanceTo(e.vertices[e.faces[_].a])))/2,g+=Math.sqrt(f*(f-c)*(f-m)*(f-u));return[Math.abs(p/6),g,e.faces.length]},this.get_model_info=function(e){if(void 0===o.models_ref[e])return o.model_error("get_model_info - id not found: "+e);var t=o.models[o.models_ref[e]];if(!t)return null;if(!t.mesh)return null;if(!t.mesh.geometry)return null;var a=t.mesh.geometry?o.calc_volume_and_area(t.mesh.geometry):[0,0,0];return{name:t.filename?t.filename:t.local_file?t.local_file.name:"",orig_filename:t.orig_filename?t.orig_filename:null,position:{x:t.x,y:t.y,z:t.z},dims:{x:t.mesh.geometry.maxx-t.mesh.geometry.minx,y:t.mesh.geometry.maxy-t.mesh.geometry.miny,z:t.mesh.geometry.maxz-t.mesh.geometry.minz},rotation:{x:t.mesh.rotation.x,y:t.mesh.rotation.y,z:t.mesh.rotation.z},display:t.display?t.display:null,color:t.color?t.color:null,scale:{x:t.scalex,y:t.scaley,z:t.scalez},volume:a[0],area:a[1],triangles:a[2]}},this.get_vsb=function(){var e=[];return Object.keys(o.models_ref).forEach(function(t){e.push({id:t,bin:o.get_stl_bin(t)})}),{vsj:o.get_vsj(!0,!0),files:e}},this.get_vsj=function(e,t){o.camera.position;var a={canvas_height:o.canvas_height,bg_color:o.bg_color,camera_state:o.get_camera_state(),auto_rotate:o.auto_rotate,mouse_zoom:o.mouse_zoom,auto_resize:o.auto_resize,center_models:o.center_models,models:[]};return Object.keys(o.models_ref).forEach(function(e){var i=o.models[o.models_ref[e]],s={id:i.id};i.filename&&(s.filename=t?o.basename(i.filename):i.filename),i.local_file&&(s.local_file=i.local_file),i.x&&(s.x=i.x),i.y&&(s.y=i.y),i.z&&(s.z=i.z),i.display&&(s.display=i.display),i.color&&(s.color=i.color),i.rotationx&&(s.rotationx=i.rotationx),i.rotationy&&(s.rotationy=i.rotationy),i.rotationz&&(s.rotationz=i.rotationz),void 0!==i.scale&&1!=i.scale&&(s.scale=i.scale),1!=i.scalex&&(s.scalex=i.scalex),1!=i.scaley&&(s.scaley=i.scaley),1!=i.scalez&&(s.scalez=i.scalez),void 0!==i.opacity&&1!=i.opacity&&(s.opacity=i.opacity),i.view_edges&&(s.view_edges=i.view_edges),i.animation&&(s.animation=JSON.parse(JSON.stringify(i.animation)),delete s.animation.start_time,delete s.animation.last_time),a.models.push(s)}),e?a:JSON.stringify(a)},this.download_vsj=function(e){var t=new Blob([o.get_vsj()],{type:"application/json"}),a=document.createElement("a");a.href=window.URL.createObjectURL(t);var i=e||"1",s=i.toLowerCase().indexOf(".vsj");s>=0&&(i=i.substring(0,s)),i.length<1&&(i="1"),a.download=i+".vsj",a.click()},this.load_vsj=function(e){if(!e)return o.pre_loaded_vsj?(stl_viewer.init_by_json(o.pre_loaded_vsj),o.pre_loaded_vsj=null,!0):o.model_error("load_vsj - invalid filename"+e,o.load_error_callback);if(e instanceof File)return o.read_bin_file(e,o.init_by_json,null,!0);var t=new XMLHttpRequest;t.onreadystatechange=function(e){4==t.readyState&&200==t.status&&o.init_by_json(t.response.trim())},t.open("GET",e,!0),t.send(null)},this.padend=function(e,t,o){return t>>=0,o=String(void 0!==o?o:" "),e.length>t?String(e):((t-=e.length)>o.length&&(o+=o.repeat(t/o.length)),String(e)+o.slice(0,t))},this.get_normal=function(e,t,o){var a=t.x-e.x,i=t.y-e.y,s=t.z-e.z,n=o.x-e.x,r=o.y-e.y,l=o.z-e.z,d={x:0,y:0,z:0};d.x=i*l-s*r,d.y=s*n-a*l,d.z=a*r-i*n;var _=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);return 0!=_&&(d.x/=_,d.y/=_,d.z/=_),d},this.get_stl_bin=function(e){if(void 0===o.models_ref[e])return o.model_error("get_stl_bin - id not found: "+e);var t=o.models[o.models_ref[e]];if(t&&t.mesh){var a=t.mesh.geometry;if(a){for(var i=new ArrayBuffer(84+50*a.faces.length),s=new DataView(i),n=(new TextEncoder,o.padend("Binary"+(t.colors?" colored":"")+" STL by viewstl.com",80," ")),r=0;r<80;r++)s.setUint8(r,n.charCodeAt(r),!0);s.setUint32(80,a.faces.length,!0);var l=84;return Object.keys(a.faces).forEach(function(e){var i=a.faces[e],n=a.vertices[i.a],r=a.vertices[i.b],d=a.vertices[i.c],_=o.get_normal(n,r,d);s.setFloat32(l,_.x,!0),l+=4,s.setFloat32(l,_.y,!0),l+=4,s.setFloat32(l,_.z,!0),l+=4,s.setFloat32(l,n.x,!0),l+=4,s.setFloat32(l,n.y,!0),l+=4,s.setFloat32(l,n.z,!0),l+=4,s.setFloat32(l,r.x,!0),l+=4,s.setFloat32(l,r.y,!0),l+=4,s.setFloat32(l,r.z,!0),l+=4,s.setFloat32(l,d.x,!0),l+=4,s.setFloat32(l,d.y,!0),l+=4,s.setFloat32(l,d.z,!0),l+=4,t.colors?s.setUint16(l,Math.ceil(31*i.color.r)|Math.ceil(31*i.color.g)<<5|Math.ceil(31*i.color.b)<<10,!0):s.setUint16(l,0,!0),l+=2}),i}}},this.basename=function(e){return e.substr(e.lastIndexOf("/")+1)},this.download_vsb=function(e){var t=null;try{t=new JSZip}catch(e){return console.log("download_vsb - JSZip is missing ",e.message),!1}var a=o.get_vsb();t.file("json_data.vsj",JSON.stringify(a.vsj)),Object.keys(a.files).forEach(function(e){t.file(o.basename(a.vsj.models[o.models_ref[a.files[e].id]].filename),a.files[e].bin)}),t.generateAsync({type:"blob"}).then(function(t){var o=new Blob([t],{type:"application/zip"}),a=document.createElement("a");a.href=window.URL.createObjectURL(o);var i=e||"1",s=i.toLowerCase().indexOf(".vsb");s>=0&&(i=i.substring(0,s)),i.length<1&&(i="1"),a.download=i+".vsb",a.click()})},this.load_vsb=function(e){if(o.pre_loaded_ab_files=[],o.pre_loaded_vsj=null,e instanceof File)return o.read_bin_file(e,o.load_vsb_from_blob);JSZipUtils.getBinaryContent(decodeURIComponent(e),function(e,t){if(e)return o.model_error("load_vsb "+e,o.load_error_callback);o.load_vsb_from_blob(t)})},this.read_bin_file=function(e,t,o,a){var i=new FileReader;i.onerror=function(e){return console.log("reading file error",e),null},i.onload=function(e){return t(e.target.result)},o&&(i.onprogress=function(e){o({loaded:e.loaded,total:e.total,load_session:-1},-1)}),a?i.readAsText(e):i.readAsArrayBuffer(e)},this.load_vsb_from_blob=function(e){var t=null;try{t=new JSZip}catch(e){return console.log("load vsb - JSZip is missing ",e.message),!1}t.loadAsync(e).then(function(){o.zip_load_count=Object.keys(t.files).length,t.forEach(function(e,a){"json_data.vsj"==a.name?t.files[a.name].async("string").then(function(e){o.pre_loaded_vsj=e,o.zip_load_count--,0==o.zip_load_count&&o.load_vsj(null)}):t.files[a.name].async("blob").then(function(e){o.pre_loaded_ab_files[a.name]=e,o.zip_load_count--,0==o.zip_load_count&&o.load_vsj(null)})})})},this.load_bin_to_ab_file=function(e,t){o.pre_loaded_ab_files||(o.pre_loaded_ab_files=[]),o.pre_loaded_ab_files[e]=t,o.add_model({id:-1,filename:e})},this.download_model=function(e,t){if(void 0===o.models_ref[e])return o.model_error("download_model - id not found: "+e);var a=o.models[o.models_ref[e]];if(a&&a.mesh){var i=new Blob([o.get_stl_bin(e)],{type:"application/sla"}),s=document.createElement("a");s.href=window.URL.createObjectURL(i);var n=t||(a.filename?a.filename:a.local_file?a.local_file.name:"1"),r=n.toLowerCase().indexOf(".stl");r>=0&&(n=n.substring(0,r)),n.length<1&&(n="1"),s.download=n+".stl",s.click()}},this.get_model_mesh=function(e){if(void 0===o.models_ref[e])return o.model_error("get_model_mesh - id not found: "+e);var t=o.models[o.models_ref[e]];return t&&t.mesh?t.mesh.clone():void 0},this.set_auto_rotate=function(e){o.controls.autoRotate=e},this.set_mouse_zoom=function(e){o.controls.noZoom=!e},this.WORLD_X_VECTOR=null,this.WORLD_Y_VECTOR=null,this.WORLD_Z_VECTOR=null,this.maxx=null,this.maxy=null,this.maxz=null,this.minx=null,this.miny=null,this.minz=null,this.edges_material=null,this.raycaster=null,this.mouse=null,this.scene=null,this.is_webgl=null,this.renderer=null,this.camera=null,this.ambientLight=null,this.directionalLight=null,this.pointLight=null,this.controls=null,this.do_resize=function(){var e=o.parent_element.getBoundingClientRect(),t=e.width,a=e.height;o.camera.aspect=t/a,o.camera.updateProjectionMatrix(),o.renderer.setSize(t-5,a-5)},this.animation=new Array,this.animate=function(){Object.keys(o.animation).forEach(function(e){void 0!==o.models_ref[e]&&o.do_model_animation(o.models[o.models_ref[e]])}),requestAnimationFrame(o.animate),o.renderer.render(o.scene,o.camera),o.controls&&o.controls.update()},this.do_model_animation=function(e){if(e.animation){var t=Date.now();if(e.animation.start_time||(e.animation.start_time=t),e.animation.delta){var a=(t-e.animation.start_time)/e.animation.delta.msec,i=e.animation.last_time?(t-e.animation.last_time)/e.animation.delta.msec:a;if(o.animation_next_delta(e,e.animation.delta,i),a>=1){if(!e.animation.delta.loop)return void o.remove_model_animation(e,!0);e.animation.delta.start_time=null}}if(e.animation.exact){i=(t-(e.animation.last_time?e.animation.last_time:e.animation.start_time))/e.animation.exact.msec;if(o.animation_next_exact(e,e.animation.exact,i),t>=e.animation.start_time+e.animation.exact.msec)return void o.remove_model_animation(e,!1,!0)}e.animation.last_time=t}},this.animation_next_delta=function(e,t,a){var i=!1,s=!1,n=!1;Object.keys(t).forEach(function(r){switch(r){case"x":case"y":case"z":i||(i=!0,o.set_position(e.id,e.x+(void 0!==t.x?t.x*a:0),e.y+(void 0!==t.y?t.y*a:0),e.z+(void 0!==t.z?t.z*a:0)));break;case"rotationx":case"rotationy":case"rotationz":s||(s=!0,o.rotate(e.id,void 0!==t.rotationx?t.rotationx*a:0,void 0!==t.rotationy?t.rotationy*a:0,void 0!==t.rotationz?t.rotationz*a:0));break;case"scale":case"scalex":case"scaley":case"scalez":n||(n=!0,t.scalex=t.scalex?t.scalex:t.scale?t.scale:null,t.scaley=t.scaley?t.scaley:t.scale?t.scale:null,t.scalez=t.scalez?t.scalez:t.scale?t.scale:null,o.set_scale(e.id,e.scalex+(void 0!==t.scalex?t.scalex*a:0),e.scaley+(void 0!==t.scaley?t.scaley*a:0),e.scalez+(void 0!==t.scalez?t.scalez*a:0)))}})},this.animation_next_exact=function(e,t,a){var i=!1,s=!1,n=!1;Object.keys(t).forEach(function(r){switch(r){case"x":case"y":case"z":i||(i=!0,void 0===t.xtotal&&(t.xtotal=t.x-e.x),void 0===t.ytotal&&(t.ytotal=t.y-e.y),void 0===t.ztotal&&(t.ztotal=t.z-e.z),o.set_position(e.id,e.x+(void 0!==t.x?t.xtotal*a:0),e.y+(void 0!==t.y?t.ytotal*a:0),e.z+(void 0!==t.z?t.ztotal*a:0)));break;case"rotationx":case"rotationy":case"rotationz":if(!s){s=!0;var l=e.mesh.getWorldRotation();void 0===t.rotxtotal&&(t.rotxtotal=t.rotationx-l.x),void 0===t.rotytotal&&(t.rotytotal=t.rotationy-l.y),void 0===t.rotztotal&&(t.rotztotal=t.rotationz-l.z),o.rotate(e.id,void 0!==t.rotationx?t.rotxtotal*a:0,void 0!==t.rotationy?t.rotytotal*a:0,void 0!==t.rotationz?t.rotztotal*a:0)}break;case"scale":case"scalex":case"scaley":case"scalez":n||(n=!0,t.scalex=t.scalex?t.scalex:t.scale?t.scale:null,t.scaley=t.scaley?t.scaley:t.scale?t.scale:null,t.scalez=t.scalez?t.scalez:t.scale?t.scale:null,void 0===t.scalextotal&&(t.scalextotal=t.scalex-e.scalex),void 0===t.scaleytotal&&(t.scaleytotal=t.scaley-e.scaley),void 0===t.scaleztotal&&(t.scaleztotal=t.scalez-e.scalez),o.set_scale(e.id,e.scalex+(void 0!==t.scalex?t.scalextotal*a:0),e.scaley+(void 0!==t.scaley?t.scaleytotal*a:0),e.scalez+(void 0!==t.scalez?t.scaleztotal*a:0)))}})},this.remove_model_animation=function(e,t,a){t&&(e.animation.delta=null),a&&(e.animation.exact=null),e.animation.delta||e.animation.exact||(e.animation=null,delete o.animation[e.id])},this.animate_model=function(e,t){if(void 0===o.models_ref[e])return o.model_error("animate-model - id not found: "+e);var a=o.models[o.models_ref[e]];if(a){if(!t)return o.remove_model_animation(a,!0,!0);a.animation=JSON.parse(JSON.stringify(t)),a.animation.delta&&(a.animation.delta.msec||(a.animation.delta.msec=300)),a.animation.exact&&(a.animation.exact.msec||(a.animation.exact.msec=300)),o.animation[e]=1}},this.init_done=!1,this.init=function(){if(!o.init_done){switch(o.WORLD_X_VECTOR=new THREE.Vector3(1,0,0),o.WORLD_Y_VECTOR=new THREE.Vector3(0,1,0),o.WORLD_Z_VECTOR=new THREE.Vector3(0,0,1),o.edges_material=new THREE.LineBasicMaterial({color:0}),o.raycaster=new THREE.Raycaster,o.mouse=new THREE.Vector2,o.scene=new THREE.Scene,o.is_webgl=webgl_Detector.webgl,o.renderer=o.is_webgl?new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}):new THREE.CanvasRenderer({alpha:!0}),o.camera=new THREE.PerspectiveCamera(45,1,.1,1e4),o.parent_element.appendChild(o.renderer.domElement),o.scene.add(o.camera),o.ambientLight=new THREE.AmbientLight(2105376),o.camera.add(o.ambientLight),o.directionalLight=new THREE.DirectionalLight(16777215,.75),o.directionalLight.position.x=1,o.directionalLight.position.y=1,o.directionalLight.position.z=2,o.directionalLight.position.normalize(),o.camera.add(o.directionalLight),o.pointLight=new THREE.PointLight(16777215,.3),o.pointLight.position.x=0,o.pointLight.position.y=-25,o.pointLight.position.z=10,o.camera.add(o.pointLight),o.controls_type){case 1:o.controls=new THREE.TrackballControls(o.camera,o.renderer.domElement);break;default:o.controls=new THREE.OrbitControls(o.camera,o.renderer.domElement),o.controls.autoRotate=o.auto_rotate}o.set_on_model_mousedown(o.onmousedown_callback)}o.set_bg_color(o.bg_color),!1===o.mouse_zoom&&o.set_mouse_zoom(o.mouse_zoom),o.camera_state?o.set_camera_state(o.camera_state):o.camera.position.set(o.camerax,o.cameray,o.cameraz),o.do_resize(),o.models_to_add&&o.add_models(o.models_to_add),o.set_auto_resize(o.auto_resize),o.animate(),o.init_done=!0},this.set_auto_resize=function(e){o.do_resize&&(window.removeEventListener("resize",o.do_resize),e&&window.addEventListener("resize",o.do_resize))},this.vf_to_geo=function(e,t,a){if(!e)return null;if(!t)return null;var s=[],n=[],r=e.length;for(i=0;i<r;i++)s.push(new THREE.Vector3(e[i][0],e[i][1],e[i][2]));r=t.length;if(a)for(i=0;i<r;i++){var l=new THREE.Face3(t[i][0],t[i][1],t[i][2]);l.color.setRGB(t[i][3],t[i][4],t[i][5]),n.push(l)}else for(i=0;i<r;i++)n.push(new THREE.Face3(t[i][0],t[i][1],t[i][2]));var d=new THREE.Geometry;return d.vertices=s,d.faces=n,d.computeBoundingBox(),d.computeFaceNormals(),d.computeVertexNormals(),o.center_models&&d.center(d),d},this.set_geo_minmax=function(e){var t=e.mesh.geometry;if(t.boundingBox)t.minx=t.boundingBox.min.x,t.miny=t.boundingBox.min.y,t.minz=t.boundingBox.min.z,t.maxx=t.boundingBox.max.x,t.maxy=t.boundingBox.max.y,t.maxz=t.boundingBox.max.z;else{for(var o=t.vertices,a=o[0].x,i=o[0].y,s=o[0].z,n=o[0].x,r=o[0].y,l=o[0].z,d=o.length;d--;)o[d].x<a&&(a=o[d].x),o[d].y<i&&(i=o[d].y),o[d].z<s&&(s=o[d].z),o[d].x>n&&(n=o[d].x),o[d].y>r&&(r=o[d].y),o[d].z>l&&(l=o[d].z);t.minx=a+e.x,t.miny=i+e.y,t.minz=s+e.z,t.maxx=n+e.x,t.maxy=r+e.y,t.maxz=l+e.z}},this.handleDragOver=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},this.handleFileDrop=function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.files.length>0?o.load_local_files(e.dataTransfer.files):"string"==typeof e.dataTransfer.getData("Text")&&(o.add_model({id:-1,filename:e.dataTransfer.getData("Text")}),o.on_model_drop&&o.on_model_drop(e.dataTransfer.getData("Text")))},this.load_local_files=function(e){if(e.length>0){for(var t=new Array,a=e.length,i=0;i<a;i++){switch(e[i].name.split(".").pop()){case"vsj":o.load_vsj(e[i]);break;case"vsb":o.load_vsb(e[i]);break;default:t.push({id:-1,local_file:e[i]})}o.on_model_drop&&o.on_model_drop(e[i].name)}o.add_models(t)}},this.clean=function(){if(o.scene){var e=o.scene;for(i=e.children.length;i--;)"Mesh"===e.children[i].type&&e.remove(e.children[i]);o.camera.position.set(o.camerax,o.cameray,o.cameraz),o.models=new Array,o.models_count=0,o.models_ref=new Array,o.max_model_id=0,o.load_status=new Array,o.load_session=0,o.loaded_models_arr=new Array,o.animation=new Array}},this.reset_parent_element=function(e){o.parent_element=e,o.allow_drag_and_drop&&o.set_drag_and_drop(!0),o.set_on_model_mousedown(o.onmousedown_callback),o.parent_element.appendChild(o.renderer.domElement)},this.scripts_loader=null,this.external_files_loaded=function(){o.ready=!0,o.init(),o.ready_callback&&o.ready_callback()},this.load_three=function(e){"string"!=typeof o.load_three_files&&(o.load_three_files=""),o.scripts_loader=new ScriptsLoader,o.scripts_loader.load_scripts(new Array(e+"three.min.js",e+"webgl_detector.js",e+"Projector.js",e+"CanvasRenderer.js",e+(0==o.controls_type?"OrbitControls.js":"TrackballControls.js")),o.external_files_loaded)},this.init_by_json=function(e){var t=null;try{t=JSON.parse(e)}catch(t){return console.log("json error ",e),!1}o.options=t,o.set_options(),o.ready&&o.init()},o.set_options(),o.ready?(o.init(),o.ready_callback&&o.ready_callback()):!1!==o.load_three_files?o.load_three(o.load_three_files):o.model_error("No THREE files were loaded")}function ScriptsLoader(){var e=this;this.all_loaded_callback=null,this.scripts_to_load=new Array,this.loading_scripts=new Array,this.loaded_scripts=new Array,this.scripts_are_loaded=function(t){var o=Object.keys(t);for(i=o.length;i--;)if(!e.loaded_scripts[e.get_full_name(t[i])])return!1;return!0},this.get_short_name=function(e){return e?e.substring(e.lastIndexOf("/")+1):""},this.load_scripts=function(t,o){o&&(e.all_loaded_callback=o),Object.keys(t).forEach(function(o){var a=e.get_short_name(t[o]);-1==e.scripts_to_load.indexOf(a)&&(e.loading_scripts[a]||e.loaded_scripts[a]||e.scripts_to_load.push(t[o]))}),e.load_files()},this.load_files=function(){if(0!=e.scripts_to_load.length)for(;e.scripts_to_load.length;){var t=e.scripts_to_load.shift();if(!e.loading_scripts[t]){e.loading_scripts[t]=1;var o=document.createElement("script");return o.onload=function(){var t=e.get_short_name(o.src);e.loaded_scripts[t]=1,e.loading_scripts[t]=0,e.load_files()},o.src=t,void document.head.appendChild(o)}}else e.all_loaded_callback&&e.all_loaded_callback()}}Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},init=function(){if(!window.MSStream){var e=document.currentScript.attributes.src.value,t=e.lastIndexOf("/");stl_viewer_script_path=t>0?e.substring(0,t+1):""}}();